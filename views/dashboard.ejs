<!-- views/dashboard.ejs -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Billing System</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        /* Add your custom CSS styles here */
    </style>
</head>
<body>
    <div class="container">
        <h1>Dashboard</h1><br>
        <div class="row">
            <div class="col">
                <h3>Items</h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Item Name</th>
                            <th>Price</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <% items.forEach(item => { %>
                            <tr>
                                <td><%= item.item_name %></td>
                                <td><%= item.item_price %></td>
                                <td>
                                    <button class="btn btn-primary add-item" data-name="<%= item.item_name %>" data-price="<%= item.item_price %>">Add</button>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            </div>
            <div class="col">
                <h3>Selected Items</h3>
                <ul id="selected-items"></ul>
                <div>Total Price: <span id="total-price">0</span></div>
                <div class="form-group d-none" id="gpay-details">
                    <label for="gpay-name">Name:</label>
                    <input type="text" class="form-control" id="gpay-name" placeholder="Enter Name">
                    <label for="gpay-phone">Phone Number:</label>
                    <input type="text" class="form-control" id="gpay-phone" placeholder="Enter Phone Number">
                </div>
                <div class="form-group">
                    <label for="payment-mode">Payment Mode:</label>
                    <select class="form-control" id="payment-mode">
                        <option value="cash">Cash</option>
                        <option value="gpay">Google Pay</option>
                    </select>
                </div>
                <button class="btn btn-success" id="submit-button" disabled>Submit</button>
            </div>
        </div>
        <hr>
        <h3>Recent Transactions</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Items</th>
                    <th>Price</th>
                    <th>Payment Mode</th>
                    <th>Google Pay Name</th>
                    <th>Google Pay Phone</th>
                </tr>
            </thead>
            <tbody id="recent-transactions">
                <!-- Transactions will be dynamically added here -->
            </tbody>
        </table>
        <!-- Add this button inside the recent transactions area -->
        <button class="btn btn-danger" id="delete-latest-btn">Delete Latest Transaction</button>

    </div>

    <div class="container">
        <h3>Summary</h3>
        <div>Total amount collected via Google Pay: <span id="gpay-amount">0</span></div>
        <div>Total amount collected via Cash: <span id="cash-amount">0</span></div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            // Function to fetch recent transactions
            function fetchRecentTransactions() {
                $.get('/recent-transactions', function(transactions) {
                    $('#recent-transactions').empty(); // Clear existing transactions
                    transactions.forEach(function(transaction) {
                        $('#recent-transactions').append(`<tr><td>${transaction['Items']}</td><td>${transaction['Price']}</td><td>${transaction['Payment Mode']}</td><td>${transaction['GPAY Name']}</td><td>${transaction['Phone No']}</td></tr>`);
                    });
                });
            }
            
            // Fetch recent transactions when the page loads
            fetchRecentTransactions();

            // Function to fetch summary
            function fetchSummary() {
                $.get('/summary', function(summary) {
                    $('#gpay-amount').text(summary.gpayAmount.toFixed(2));
                    $('#cash-amount').text(summary.cashAmount.toFixed(2));
                });
            }

            // Fetch summary when the page loads
            fetchSummary();

            let totalPrice = 0;

            $('.add-item').click(function() {
                const itemName = $(this).data('name');
                const itemPrice = $(this).data('price');
                totalPrice += parseFloat(itemPrice);
                $('#selected-items').append(`<li>${itemName} - ${itemPrice} <button class="btn btn-danger remove-item">Remove</button></li>`);
                $('#total-price').text(totalPrice.toFixed(2));
                checkItemsAdded(); // Check if items are added
            });

            $('#selected-items').on('click', '.remove-item', function() {
                const removedPrice = parseFloat($(this).parent().text().split(' - ')[1]);
                totalPrice -= removedPrice;
                $(this).parent().remove();
                $('#total-price').text(totalPrice.toFixed(2));
                checkItemsAdded(); // Check if items are added
            });

            $('#payment-mode').change(function() {
                const paymentMode = $(this).val();
                if (paymentMode === 'gpay') {
                    $('#gpay-details').removeClass('d-none');
                } else {
                    $('#gpay-details').addClass('d-none');
                }
            });

            $('#submit-button').click(function() {
                const items = [];
                $('#selected-items li').each(function() {
                    items.push($(this).text().split(' - ')[0]);
                });
                const totalPrice = parseFloat($('#total-price').text());
                const paymentMode = $('#payment-mode').val();
                const gpayName = $('#gpay-name').val();
                const gpayPhone = $('#gpay-phone').val();
                const data = {
                    items: items,
                    price: totalPrice,
                    paymentMode: paymentMode,
                    gpayName: gpayName,
                    gpayPhone: gpayPhone
                };
                $.post('/submit', data, function(response) {
                    console.log(response);
                    // Clear selected items and payment details
                    $('#selected-items').empty();
                    $('#total-price').text('0');
                    $('#gpay-name').val('');
                    $('#gpay-phone').val('');
                    $('#payment-mode').val('cash');
                    // Fetch recent transactions after submission
                    fetchRecentTransactions();
                    // Fetch summary after submission
                    fetchSummary();
                });
            });

            // Add this script to handle delete latest transaction button click
            $('#delete-latest-btn').click(function() {
                $.post('/delete-latest-transaction', function(response) {
                    console.log(response);
                    // After deletion, fetch recent transactions and update the area
                    fetchRecentTransactions();
                });
            });

            // Function to check if items are added
            function checkItemsAdded() {
                const itemsAdded = $('#selected-items li').length > 0;
                $('#submit-button').prop('disabled', !itemsAdded); // Disable/enable submit button based on items added
                if (!itemsAdded) {
                    alert('Please add at least one item before submitting.');
                }
            }
        });
    </script>
</body>
</html>
